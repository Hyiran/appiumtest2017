package com.oribo.report;

import java.util.Iterator;
import java.util.List;

import org.apache.log4j.Logger;
import org.testng.ITestContext;
import org.testng.ITestNGMethod;
import org.testng.ITestResult;
import org.testng.Reporter;
import org.testng.TestListenerAdapter;

import com.oribo.common.TestcaseFrame;
import com.oribo.log.ErrorLog;
import com.oribo.log.Log;

public class TestResultListener extends TestListenerAdapter{
	String casename=null;
	ITestResult it;
	ErrorLog errorlog;
	Logger logger=Log.getLogger4j();
	
   /**
    * 用例执行失败时，抓取日志并进行截图
    */
	@Override
	public void onTestFailure(ITestResult tr) {
		long time=(tr.getEndMillis() - tr.getStartMillis());
		 logger.info("Failed, method:" + tr.getMethod()
         +" #parameters:"+tr.getParameters().length
         + " time:" + time);
		it=Reporter.getCurrentTestResult(); 
		casename=it.getName();
		//抓取日志
		errorlog.catchLog(casename);
		logger.info("执行失败，已抓取日志，日志名为："+ErrorLog.getLogFilename());
		//截图
		TestcaseFrame.screenCap(TestcaseFrame.getDriver(), casename);
		logger.info("已截图，图片名为："+TestcaseFrame.scrennfilename());
		
	

	}

	@Override
	public void onTestSkipped(ITestResult tr) {
		
		 logger.info("Skipped, method:" + tr.getMethod());
	}
	/**
	 * 每一个测试方法开始执行时
	 */

	@Override
	public void onTestStart(ITestResult result) {
		// TODO Auto-generated method stub
		//开始执行用例时清除日志
		ErrorLog.clearLog();
		super.onTestStart(result);
	}

	@Override
	public List<ITestResult> getFailedTests() {
		// TODO Auto-generated method stub
		return super.getFailedTests();
	}

	@Override
	public List<ITestResult> getPassedTests() {
		// TODO Auto-generated method stub
		return super.getPassedTests();
	}

	@Override
	public List<ITestResult> getSkippedTests() {
		// TODO Auto-generated method stub
		return super.getSkippedTests();
	}

	@Override
	public void onFinish(ITestContext testContext) {
		logger.info("All Tests is finished");
		TestResultListener listener=new TestResultListener();
/*		logger.info("PASSED:"+listener.getPassedTests().size());
		logger.info("FAILED:"+listener.getFailedTests().size());
		logger.info("SKIPPED:"+listener.getSkippedTests().size());*/
		
        Iterator<ITestResult> listOfFailedTests = testContext.getFailedTests().getAllResults().iterator();
        while (listOfFailedTests.hasNext()) {
            ITestResult failedTest = listOfFailedTests.next();
            ITestNGMethod method = failedTest.getMethod();
            if (testContext.getFailedTests().getResults(method).size() > 1) {
                listOfFailedTests.remove();
            } else {
                if (testContext.getPassedTests().getResults(method).size() > 0) {
                    listOfFailedTests.remove();
                }
            }
        }
  

	}

	@Override
	public void onStart(ITestContext testContext) {
		// TODO Auto-generated method stub
		super.onStart(testContext);
	}

	@Override
	public void onTestSuccess(ITestResult tr) {
		   long time=(tr.getEndMillis() - tr.getStartMillis());
	        logger.info("Success, method:" + tr.getMethod()
	            +" #parameters:"+tr.getParameters().length
	            + " time:" + time);
	}
	
	public void getFailed()
	{
		List<ITestResult> list=getFailedTests();
		Iterator<ITestResult> it=list.iterator();
		ITestResult result;
		ITestNGMethod method;
	

		while((result=it.next())!=null)
		{
			method=result.getMethod();
			System.out.println("这下可以获取失败的方法名了吧~"+method.getMethodName());
		}
		
	}
	

}
